var map=null,doPoll=!0,statuses={Active:{color:"#1abc9c",label:"label-success",icon:"fa-laptop",point:"ct-point-active"},"In progress":{label:"label-primary"},Completed:{label:"label-success"},"USB Mounted":{color:"#f9bf3b",label:"label-warning",icon:"fa-usb",point:"ct-point-mount"},"Opened Macro":{color:"#F39C12",label:"label-clicked",icon:"fa-file",point:"ct-point-macro"},"Opened Executable":{color:"#f05b4f",label:"label-danger",icon:"fa-gear",point:"ct-point-exec"},"Opened Everything":{color:"#f05b4f",label:"label-danger",icon:"fa-gear",point:"ct-point-exec"},Unknown:{color:"#6c7a89",label:"label-default",icon:"fa-question",point:"ct-point-error"},"Campaign Created":{label:"label-success",icon:"fa-rocket"}},statusMapping={Active:"active","USB Mounted":"mount","Opened Macro":"macro","Opened Executable":"exec","Opened Everything":"every"},progressListing=["Active","USB Mounted","Opened Macro","Opened Executable","Opened Everything"],campaign={},bubbles=[];function dismiss(){$("#modal\\.flashes").empty(),$("#modal").modal("hide"),$("#resultsTable").dataTable().DataTable().clear().draw()}function deleteCampaign(){Swal.fire({title:"Are you sure?",text:"This will delete the campaign. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete Campaign",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(e,t){api.campaignId.delete(campaign.id).success((function(t){e()})).error((function(e){t(e.responseJSON.message)}))}))}}).then((function(e){e.value&&Swal.fire("Campaign Deleted!","This campaign has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.href="/campaigns"}))}))}function completeCampaign(){Swal.fire({title:"Are you sure?",text:"Gophish will stop processing events for this campaign",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Complete Campaign",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(e,t){api.campaignId.complete(campaign.id).success((function(t){e()})).error((function(e){t(e.responseJSON.message)}))}))}}).then((function(e){e.value&&(Swal.fire("Campaign Completed!","This campaign has been completed!","success"),$("#complete_button")[0].disabled=!0,$("#complete_button").text("Completed!"),doPoll=!1)}))}function exportAsCSV(e){exportHTML=$("#exportButton").html();var t=null,a=campaign.name+" - "+capitalize(e)+".csv";switch(e){case"results":t=campaign.results;break;case"events":t=campaign.timeline}if(t){$("#exportButton").html('<i class="fa fa-spinner fa-spin"></i>');var s=Papa.unparse(t,{escapeFormulae:!0}),i=new Blob([s],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(i,a);else{var n=window.URL.createObjectURL(i),l=document.createElement("a");l.href=n,l.setAttribute("download",a),document.body.appendChild(l),l.click(),document.body.removeChild(l)}$("#exportButton").html(exportHTML)}}function renderTimeline(e){return record={id:e[0],hostname:e[2],os:e[3],username:e[4],status:e[5]},results='<div class="timeline col-sm-12 well well-lg"><h6>Timeline for '+escapeHtml(record.hostname)+'</h6><span class="subtitle">Result ID: '+escapeHtml(record.id)+'</span><div class="timeline-graph col-sm-6">',$.each(campaign.timeline,(function(e,t){t.hostname&&t.hostname!=record.hostname||(results+='<div class="timeline-entry">    <div class="timeline-bar"></div>',results+='    <div class="timeline-icon '+statuses[t.message].label+'">    <i class="fa '+statuses[t.message].icon+'"></i></div>    <div class="timeline-message">'+escapeHtml(t.message)+'    <span class="timeline-date">'+moment.utc(t.time).local().format("MMMM Do YYYY h:mm:ss a")+'</span>    <span class="timeline-username">'+escapeHtml(t.details.username)+"</span>",results+="</div></div>")})),results+="</div></div>",results}var setRefresh,renderTimelineChart=function(e){return Highcharts.chart("timeline_chart",{chart:{zoomType:"x",type:"line",height:"200px"},title:{text:"Campaign Timeline"},xAxis:{type:"datetime",dateTimeLabelFormats:{second:"%l:%M:%S",minute:"%l:%M",hour:"%l:%M",day:"%b %d, %Y",week:"%b %d, %Y",month:"%b %Y"}},yAxis:{min:0,max:2,visible:!1,tickInterval:1,labels:{enabled:!1},title:{text:""}},tooltip:{formatter:function(){return Highcharts.dateFormat("%A, %b %d %l:%M:%S %P",new Date(this.x))+"<br>Event: "+this.point.message+"<br>Hostname: <b>"+this.point.hostname+"</b>"}},legend:{enabled:!1},plotOptions:{series:{marker:{enabled:!0,symbol:"circle",radius:3},cursor:"pointer"},line:{states:{hover:{lineWidth:1}}}},credits:{enabled:!1},series:[{data:e.data,dashStyle:"shortdash",color:"#cccccc",lineWidth:1,turboThreshold:0}]})},renderPieChart=function(e){return Highcharts.chart(e.elemId,{chart:{type:"pie",events:{load:function(){var t=this,a=t.renderer,s=t.series[0],i=t.plotLeft+s.center[0],n=t.plotTop+s.center[1];this.innerText=a.text(e.data[0].count,i,n).attr({"text-anchor":"middle","font-size":"24px","font-weight":"bold",fill:e.colors[0],"font-family":"Helvetica,Arial,sans-serif"}).add()},render:function(){this.innerText.attr({text:e.data[0].count})}}},title:{text:e.title},plotOptions:{pie:{innerSize:"80%",dataLabels:{enabled:!1}}},credits:{enabled:!1},tooltip:{formatter:function(){return null!=this.key&&'<span style="color:'+this.color+'">‚óè</span>'+this.point.name+": <b>"+this.y+"%</b><br/>"}},series:[{data:e.data,colors:e.colors}]})},updateMap=function(e){map&&(bubbles=[],$.each(campaign.results,(function(e,t){if(0==t.latitude&&0==t.longitude)return!0;newIP=!0,$.each(bubbles,(function(e,a){if(a.ip==t.ip)return bubbles[e].radius+=1,newIP=!1,!1})),newIP&&bubbles.push({latitude:t.latitude,longitude:t.longitude,name:t.ip,fillKey:"point",radius:2})})),map.bubbles(bubbles))};function createStatusLabel(e){return'<span class="label '+(statuses[e].label||"label-default")+'">'+e+"</span>"}function poll(){api.campaignId.results(campaign.id).success((function(e){campaign=e;var t=[];$.each(campaign.timeline,(function(e,a){var s=moment.utc(a.time).local();t.push({hostname:a.hostname,message:a.message,x:s.valueOf(),y:1,marker:{fillColor:statuses[a.message].color}})})),$("#timeline_chart").highcharts().series[0].update({data:t});var a={};Object.keys(statusMapping).forEach((function(e){a[e]=0})),$.each(campaign.results,(function(e,t){a[t.status]++;var s=progressListing.indexOf(t.status);for(e=0;e<s;e++)a[progressListing[e]]++})),$.each(a,(function(e,t){var a=[];if(!(e in statusMapping)||"Opened Everything"==e)return!0;a.push({name:e,y:Math.floor(t/campaign.results.length*100),count:t}),a.push({name:"",y:100-Math.floor(t/campaign.results.length*100)}),$("#"+statusMapping[e]+"_chart").highcharts().series[0].update({data:a})})),resultsTable=$("#resultsTable").DataTable(),resultsTable.rows().every((function(e,t,a){var s=this.row(e),i=s.data(),n=i[0];$.each(campaign.results,(function(t,a){if(a.id==n)return i[6]=a.status,resultsTable.row(e).data(i),s.child.isShown()&&($(s.node()).find("#caret").removeClass("fa-caret-right"),$(s.node()).find("#caret").addClass("fa-caret-down"),s.child(renderTimeline(s.data()))),!1}))})),resultsTable.draw(!1),updateMap(campaign.results),$('[data-toggle="tooltip"]').tooltip(),$("#refresh_message").hide(),$("#refresh_btn").show()}))}function load(){campaign.id=window.location.pathname.split("/").slice(-1)[0];var e=JSON.parse(localStorage.getItem("gophishusb.use_map"));api.campaignId.results(campaign.id).success((function(t){if(campaign=t){$("title").text(t.name+" - GophishUSB"),$("#loading").hide(),$("#campaignResults").show(),$("#page-title").text("Results for "+t.name),"Completed"==t.status&&($("#complete_button")[0].disabled=!0,$("#complete_button").text("Completed!"),doPoll=!1),$("#resultsTable").on("click",".timeline-event-details",(function(){payloadResults=$(this).parent().find(".timeline-event-results"),payloadResults.is(":visible")?($(this).find("i").removeClass("fa-caret-down"),$(this).find("i").addClass("fa-caret-right"),payloadResults.hide()):($(this).find("i").removeClass("fa-caret-right"),$(this).find("i").addClass("fa-caret-down"),payloadResults.show())})),resultsTable=$("#resultsTable").DataTable({destroy:!0,order:[[0,"asc"]],columns:[{title:"Target ID"},{title:"",className:"details-control"},{title:"Hostname"},{title:"OS"},{title:"Last User"},{title:"Status"}],columnDefs:[{orderable:!1,targets:"no-sort"},{className:"details-control",targets:[1]},{visible:!0,targets:[0,5]},{render:function(e){return createStatusLabel(e)},targets:[5]}]}),resultsTable.clear();var a={},s=[];Object.keys(statusMapping).forEach((function(e){a[e]=0})),$.each(campaign.results,(function(e,t){resultsTable.row.add([t.target_id,'<i id="caret" class="fa fa-caret-right"></i>',escapeHtml(t.hostname)||"",escapeHtml(t.os)||"",escapeHtml(t.username)||"",t.status]),a[t.status]++;var s=progressListing.indexOf(t.status);for(e=0;e<s;e++)a[progressListing[e]]++})),resultsTable.draw(),$('[data-toggle="tooltip"]').tooltip(),$("#resultsTable tbody").on("click","td.details-control",(function(){var e=$(this).closest("tr"),t=resultsTable.row(e);t.child.isShown()?(t.child.hide(),e.removeClass("shown"),$(this).find("i").removeClass("fa-caret-down"),$(this).find("i").addClass("fa-caret-right")):($(this).find("i").removeClass("fa-caret-right"),$(this).find("i").addClass("fa-caret-down"),t.child(renderTimeline(t.data())).show(),e.addClass("shown"))})),$.each(campaign.timeline,(function(e,t){if("Campaign Created"==t.message)return!0;var a=moment.utc(t.time).local();s.push({hostname:t.hostname,username:t.username,message:t.message,x:a.valueOf(),y:1,marker:{fillColor:statuses[t.message].color}})})),renderTimelineChart({data:s}),$.each(a,(function(e,t){var a=[];if(!(e in statusMapping)||"Opened Everything"==e)return!0;a.push({name:e,y:Math.floor(t/campaign.results.length*100),count:t}),a.push({name:"",y:100-Math.floor(t/campaign.results.length*100)});renderPieChart({elemId:statusMapping[e]+"_chart",title:e,name:e,data:a,colors:[statuses[e].color,"#dddddd"]})})),e&&($("#resultsMapContainer").show(),map=new Datamap({element:document.getElementById("resultsMap"),responsive:!0,fills:{defaultFill:"#ffffff",point:"#283F50"},geographyConfig:{highlightFillColor:"#1abc9c",borderColor:"#283F50"},bubblesConfig:{borderColor:"#283F50"}})),updateMap(campaign.results)}})).error((function(){$("#loading").hide(),errorFlash("Campaign not found!")}))}function refresh(){doPoll&&($("#refresh_message").show(),$("#refresh_btn").hide(),poll(),clearTimeout(setRefresh),setRefresh=setTimeout(refresh,6e4))}$(document).ready((function(){Highcharts.setOptions({global:{useUTC:!1}}),load(),setRefresh=setTimeout(refresh,6e4)}));